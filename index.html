<!DOCTYPE html>
<html>
 <head>
  <title>Online Digital Signature</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="utf-8" />
  <!-- Bootstrap 5.3.0 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
  <!-- jQuery 3.7.0 -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script>
  <!-- Signature Pad 4.1.5 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.5/signature_pad.umd.min.js" integrity="sha512-ngaalT22GGVs6hGMprLZ39ulFSdC/WUty7LR5AaFxpkDp5TUQ/w11WOIvZBktWOP/e9aA9m/xxpBUNDWpadROA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- pdf-lib 1.17.1 -->
  <script src="https://unpkg.com/pdf-lib"></script>
  <!-- Fontawesome 6.4.0 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>

    html, body {
        height: 100%;
    }
    
    iframe {
        overflow: hidden;
        position: absolute;
        top: 0px;
        left: 0px;
        width: 100%;
        height: 100%;
        z-index: 0;
    }

    /*
        let color default size same with other input column
    */
    input[type="color"] {
        min-width: 205px;
    }

    #preview-container {
        position: relative;
        height: calc(100vh - 20px);
        overflow: hidden;
    }

  </style>
  <script>
    
    const britishDatetime = (d = new Date(), UTC = 8) => {
        d.setHours(d.getHours() + UTC);

        const datetime = d.toISOString();
        const date = datetime.substring(0, 10).split('-').reverse().join('/');
        const time = datetime.substring(11, 19);

        return { 
            datetime: `${date} ${time}`, 
            date, time 
        };
    }

    const setSignaturePad = ({
        id = "signature-canvas", 
        w = 300, h = 150, 
    }) => {
        const canvas_element = document.getElementById(id);

        canvas_element.width = w;
        canvas_element.height = h;
    }

    const getAdjust = (
        x_id = "#adjust-x", 
        y_id = "#adjust-y", 
        scale_id = "#adjust-scale"
    ) => ({
        x: parseFloat($(x_id).val()), 
        y: parseFloat($(y_id).val()), 
        scale: parseFloat($(scale_id).val()), 
    });
    
    const colorHextoRGB = (hex_str = "#ff0000") => ({
        r: parseInt(hex_str.substring(1, 3), 16), 
        g: parseInt(hex_str.substring(3, 5), 16), 
        b: parseInt(hex_str.substring(5, 7), 16), 
    })

    const getWatermark = ({
        text_id = "#watermark-text", 
        size_id = "#watermark-size", 
        color_id = "#watermark-color", 
        opacity_id = "#watermark-opacity", 

        angle_id = "#watermark-angle", 
        x_id = "#watermark-x", 
        y_id = "#watermark-y", 
    }) => ({
        text: $(text_id).val(), 
        size: parseInt($(size_id).val()), 
        color: colorHextoRGB($(color_id).val()), 
        opacity: parseFloat($(opacity_id).val()),  
        
        angle: parseFloat($(angle_id).val()), 
        x: parseFloat($(x_id).val()), 
        y: parseFloat($(y_id).val()), 
    });

    //  calculate after rotate, text (watermark) center position
    //  [calculation generate by Bing GPT]
    const getRotateXY = ({
        angle = 45, 
        //  start position
        start = {
            x: getAdjust().x, 
            y: getAdjust().y, 
            width, height, 
        }, 
        text = { width, height }, 
    }) => {
        const rad = (angle * Math.PI) / 180;            // 角度转弧度
        const centerX = start.x + (start.width / 2);    // 签名中心点 X 坐标
        const centerY = start.y + (start.height / 2);   // 签名中心点 Y 坐标

        // 计算旋转后的文本位置
        const x = 
            centerX - 
            (text.width / 2) * Math.cos(rad) - 
            (text.height / 2) * Math.sin(rad); 
        const y =
            centerY -
            (text.width / 2) * Math.sin(rad) +
            (text.height / 2) * Math.cos(rad) - 
            (text.height / 2); 
        
        return { x, y };
    }

    const updateIframePDF = async({
        pdf_bytes, signed_base64 = "", 
        adjust = getAdjust(), 
        watermark = getWatermark({}), 
        watermark_position = "auto", 
    }) => {
        //  not selected pdf file
        if(!pdf_bytes) return;

        const pdfDoc = await PDFLib.PDFDocument.load(pdf_bytes);
        const pages = pdfDoc.getPages();
        
        if(signed_base64 !== ""){
            //   text (pdf-lib) setting
            const font = await pdfDoc.embedFont(PDFLib.StandardFonts.TimesRoman);
            const { rgb, degrees } = PDFLib;
            //  convert signature to bytes and image (pdf-lib)
            const signed_bytes = await fetch(signed_base64).then((res) => res.arrayBuffer());
            const signed_object = await pdfDoc.embedPng(signed_bytes);
            const signed_image = signed_object.scale(adjust.scale);
            const { width, height } = signed_image;
            
            for(let i=0; i<pages.length; i++){
                const text_w = font.widthOfTextAtSize(watermark.text, watermark.size);
                const text_h = font.sizeAtHeight(watermark.size);
                //  pdf-lib color 1 = 100% = 255 
                const [r, g, b] = [
                    watermark.color.r / 255, 
                    watermark.color.g / 255, 
                    watermark.color.b / 255
                ];
                //  watermark position manually or auto
                const { x, y } = (watermark_position === "auto")?
                    getRotateXY({
                        angle: watermark.angle, 
                        start: {
                            //  x, y, width, height, 
                            ...adjust, 
                            width, height, 
                        }, 
                        text: {
                            width: text_w, 
                            height: text_h, 
                        }
                    })
                    :
                    { ...watermark }

                $("#watermark-x").val(x.toFixed(2));
                $("#watermark-y").val(y.toFixed(2));

                //  draw watermark
                pages[i].drawText(watermark.text, {
                    x, y, 
                    size: watermark.size, 
                    rotate: degrees(watermark.angle), 
                    
                    color: rgb(r, g, b), 
                    opacity: watermark.opacity, 
                });
                
                //  draw signature
                pages[i].drawImage(signed_object, {
                    ...adjust, 
                    width, height, 
                });
            }
        }
        
        const base64_uri = await pdfDoc.saveAsBase64({ dataUri: true });
        let iframe = document.createElement("iframe");
        
        iframe.id = "pdf-1";
        iframe.style.zIndex = 0;

        iframe.onload = async() => {
            const delay = (ms = 1000) => 
                new Promise(resolve => setTimeout(resolve, ms));
            
            if($("#pdf-1").length){
                await delay(1000);

                document.getElementById("pdf-1").style.zIndex = 100;
                document.getElementById("preview-container").removeChild(document.getElementById("pdf"));
                $("#pdf-1").attr("id", "pdf");
            }
        }

        iframe.src = base64_uri;
        $("#preview-container").append(iframe);
    }

    const base64ToBuffer = (base64) => {
        const binary = window.atob(base64);
        let bytes = new Uint8Array(binary.length);
        
        for(let i = 0; i<binary.length; i++)
            bytes[i] = binary.charCodeAt(i);
        return bytes;
    }

    $(document).ready(() => {
        const url = new URL(window.location.href);
        const signatue_canvas = document.getElementById("signature-canvas");
        const signature_pad = new SignaturePad(signatue_canvas);
        let pdf_bytes = null;
        
        //  set the signature pad with url parameter exist or default values
        setSignaturePad({
            w: parseFloat(url.searchParams.get("w") || 300), 
            h: parseFloat(url.searchParams.get("h") || 150), 
        });
        //  set default watermark text
        $("#watermark-text").val(`Signed on ${britishDatetime().datetime}`);

        //  when stop signing will update the preview iframe
        signature_pad.addEventListener("endStroke", () => {
            updateIframePDF({
                pdf_bytes, 
                signed_base64: signatue_canvas.toDataURL()
            });
        });

        $("#origin-pdf").bind("change", function(){
            const file = this.files[0];

            if(file){
                let fileReader = new FileReader();

                fileReader.onload = function(){
                    //  get selected pdf file bytes
                    pdf_bytes = new Uint8Array(this.result);
                    updateIframePDF({ pdf_bytes });
                };

                fileReader.readAsArrayBuffer(file);
            }
        });
        
        /*
            Adjust Signature
        */
        $("#signature-width, #signature-height").bind("change", () => {
            const w = parseInt($("#signature-width").val());
            const h = parseInt($("#signature-height").val());
            
            setSignaturePad({ w, h });
        });

        $("#adjust-x, #adjust-y, #adjust-scale").bind("change", () => {
            updateIframePDF({
                pdf_bytes, 
                signed_base64: signatue_canvas.toDataURL()
            });
        });

        /*
            Watermark 
        */
        $(` #watermark-text, #watermark-size, #watermark-color, 
            #watermark-opacity, #watermark-angle`)
            .bind("change", () => {
                updateIframePDF({
                    pdf_bytes, 
                    signed_base64: signatue_canvas.toDataURL()
                });
            });
        
        $("#watermark-x, #watermark-y").bind("change", () => {
            updateIframePDF({
                pdf_bytes, 
                signed_base64: signatue_canvas.toDataURL(), 
                watermark_position: "manually"
            });
        });

        /*
            Signature (Clear, Undo, Confirm)
        */
        $("#btn-clear").bind("click", () => {
            signature_pad.clear();
            updateIframePDF({ pdf_bytes });
        });

        $("#btn-undo").bind("click", () => {
            const datas = signature_pad.toData();

            if(datas.length > 0){
                datas.pop();
                signature_pad.fromData(datas);

                signature_pad.isEmpty()?
                    updateIframePDF({ pdf_bytes })
                    :
                    updateIframePDF({
                    pdf_bytes, 
                    signed_base64: signatue_canvas.toDataURL()
                });
            }
        });

        $("#btn-download").bind("click", () => {
            if(signature_pad.isEmpty() )
                alert('Please provide a signature first.');
            else{
                const base64_pdf = $("#pdf").attr("src");
                const link = document.createElement ("a");
                
                link.href = base64_pdf;
                link.download = "signed.pdf";
                link.click();
            }
        });
    
        $("#btn-share").bind("click", () => {
            const base64 = $("#pdf").attr("src").split(',')[1] || "";

            if(base64){
                const buffer = base64ToBuffer(base64);
                const pdf = new File([buffer], "signed.pdf", { type: "application/pdf" });
                const files = [pdf];

                if(navigator.canShare({ files }))
                    navigator.share({ files })
                        .catch(err => {
                            const err_msg = `Fail to share pdf file.`;

                            console.error(err);
                            console.log(err_msg);
                            alert(err_msg);
                        });
                else
                    alert(`Your browser not support to share pdf file.`);
            }
        });
    });

  </script>
 </head>
 <body class="text-light bg-dark">

  <div class="container-fluid min-vh-100">
   <div class="row m-0 w-100 min-vh-100 text-center d-flex align-items-center">
    <!-- Input PDF File & Signature -->
    <div class="col-md min-vh-100 p-0">
     <!-- Row: Choose PDF -->
     <div class="row mt-2">
      <div class="col">
       <div class="my-4">
        <label for="origin-pdf" class="form-label">
         <button class="btn px-4 btn-outline-success" onclick="$('#origin-pdf').click()">
          <i class="fa-solid fa-file-pdf"></i>
          <span>Input Your PDF</span>
         </button>
        </label>
        <!-- Hide Default File Input -->
        <input id="origin-pdf" class="form-control d-none" type="file" accept=".pdf" />
       </div>
      </div>
     </div>
     <!-- End of Row: Choose PDF -->

     <!-- Switches: Adjust & Watermark -->
     <div class="row align-items-center justify-content-md-center">
      <div class="col-6 col-lg-4">
       <button 
            id="btn-setting" type="button" class="btn px-4 btn-outline-primary"
            data-bs-toggle="collapse" data-bs-target="#collapse-setting" aria-expanded="false"
       >
        <i class="fa-solid fa-gear"></i>
        <span>Setting</span>
       </button>
      </div>
      <div class="col-6 col-lg-4 pe-4">
       <div class="form-check form-switch form-check-reverse">
        <input id="chk-watermark" class="form-check-input" type="checkbox" role="switch" checked />
        <label for="chk-watermark" class="form-check-label">
         <i class="fa-solid fa-paintbrush me-1"></i>
         <span>Watermark</span>
        </label>
       </div>
      </div>
     </div>

     <!-- Collapse: Setting -->
     <div class="collapse" id="collapse-setting">
     <!-- Row: Adjust Signature -->
     <div class="row justify-content-md-center mt-4">
      <!-- Width -->
      <div class="col-md-auto">
       <div class="form-floating">
        <input id="signature-width" class="form-control" type="number" min="100" step="10" value="300" />
        <label for="signature-width">
         <i class="fa-solid fa-x me-1"></i>
         <span>Signature Width</span>
        </label>
       </div>
      </div>
      <!-- Height -->
      <div class="col-md-auto">
       <div class="form-floating">
        <input id="signature-height" class="form-control" type="number" min="100" step="10" value="150" />
        <label for="signature-width">
         <i class="fa-solid fa-x me-1"></i>
         <span>Signature Height</span>
        </label>
       </div>
      </div>
      <!-- Color -->
      <div class="col-md-auto">
        <div class="form-floating">
         <input id="signature-width" class="form-control" type="color" value="#000000" />
         <label for="signature-width">
          <i class="fa-solid fa-x me-1"></i>
          <span>Signature Color</span>
         </label>
        </div>
       </div>
     </div>
     <!-- Row: Signature X-Axis, Y-Axis, Scale -->
     <div class="row justify-content-md-center">
      <!-- X-Axis -->
      <div class="col-md-auto">
       <div class="form-floating">
        <input id="adjust-x" class="form-control" type="number" min="0" step="5" value="255" />
        <label for="adjust-x">
         <i class="fa-solid fa-x me-1"></i>
         <span>Signature X-Axis</span>
        </label>
       </div>
      </div>
      <!-- Y-Axis -->
      <div class="col-md-auto">
        <div class="form-floating">
         <input id="adjust-y" class="form-control" type="number" min="0" step="5" value="45" />
         <label for="adjust-y">
          <i class="fa-solid fa-y me-1"></i>
          <span>Signature Y-Axis</span>
         </label>
        </div>
      </div>
      <!-- Scale (Size) -->
      <div class="col-md-auto">
        <div class="form-floating">
         <input id="adjust-scale" class="form-control" type="number" min="0.1" step="0.05" value="0.3" />
         <label for="adjust-scale">
          <i class="fa-solid fa-maximize me-1"></i>
          <span>Signature Scale (Size)</span>
         </label>
        </div>
      </div>

     </div>
     <!-- End of Row: Adjust Signature -->
     <!-- Row: Watermark -->
     <div class="row justify-content-md-center mt-4">
      <div class="row justify-content-md-center">
       <!-- Font Text -->
       <div class="col-md-9">
        <div class="form-floating">
         <input id="watermark-text" class="form-control" type="text" />
         <label for="watermark-text">
          <i class="fa-solid fa-comment-dots me-1"></i>
          <span>Watermark Text</span>
         </label>
        </div>
       </div>
      </div>
     <!-- Row: Size, Color, Opacity -->
     <div class="row justify-content-md-center">
      <!-- Font Size -->
      <div class="col-md-3">
       <div class="form-floating">
        <input id="watermark-size" class="form-control" type="number" min="1" value="10" />
        <label for="watermark-size">
         <i class="fa-solid fa-font me-1"></i>
         <span>Watermark Size</span>
        </label>
       </div>
      </div>
      <!-- Font Color -->
      <div class="col-md-3">
       <div class="form-floating">
        <input id="watermark-color" class="form-control" type="color" min="1" value="#941818" />
        <label for="watermark-color">
         <i class="fa-solid fa-palette me-1"></i>
         <span>Watermark Color</span>
        </label>
       </div>
      </div>
      <!-- Font Opacity -->
      <div class="col-md-3">
       <div class="form-floating">
        <input id="watermark-opacity" class="form-control" type="number" min="0" max="1" step="0.05" value="0.5" />
        <label for="watermark-opacity">
         <i class="fa-solid fa-eye me-1"></i>
         <span>Watermark Opacity</span>
        </label>
       </div>
      </div>
     </div>
     <!-- End of Row: Size, Color, Opacity -->
     <!-- Row: Angle, X, Y -->
     <div class="row justify-content-md-center">
      <!-- Angle -->
      <div class="col-md-auto">
       <div class="form-floating">
        <input id="watermark-angle" class="form-control" type="number" min="-365" step="5" value="45" />
        <label for="watermark-angle">
         <i class="fa-solid fa-arrows-spin me-1"></i>
         <span>Watermark Angle</span>
        </label>
       </div>
      </div>
      <!-- X -->
      <div class="col-md-auto">
       <div class="form-floating">
        <input id="watermark-x" class="form-control" type="number" min="0" step="5" value="255" />
        <label for="watermark-x">
         <i class="fa-solid fa-x me-1"></i>
         <span>Watermark X-Axis</span>
        </label>
       </div>
      </div>
      <!-- Y -->
      <div class="col-md-auto">
       <div class="form-floating">
        <input id="watermark-y" class="form-control" type="number" min="0" step="5" value="45" />
        <label for="watermark-y">
         <i class="fa-solid fa-y me-1"></i>
         <span>Watermark Y-Axis</span>
        </label>
       </div>
      </div>
      <!-- End of Row: Angle, X, Y -->
      </div>
     </div>
     <!-- End of Row: Watermark -->
     </div>
     <!-- End of Collapse: Setting -->

     <!-- Row: Signature Canvas -->
     <div class="row my-5">
      <div class="col">
       <canvas 
        id="signature-canvas" class="bg-light rounded" 
        height="150" width="300" 
        style="border: 3px solid black"
       ></canvas>
       <p>
        <i class="fa-solid fa-signature me-1"></i>
        <small>Sign above</small>
       </p>
      </div>
     </div>
     <!-- End of Row: Signature Canvas -->
     <!-- Row: Button Group -->
     <div class="row">
      <!-- Clear Button -->
      <div class="col-lg-4 my-2">
       <button id="btn-clear" class="btn w-75 px-4 btn-outline-danger">
        <i class="fa-solid fa-rotate-left me-1"></i>
        <span>Clear</span>
       </button>
      </div>
      <!-- Undo Button -->
      <div class="col-lg-4 my-2">
       <button id="btn-undo" class="btn w-75 px-4 btn-outline-warning">
        <i class="fa-solid fa-backward-step me-1"></i>
        <span>Undo</span>
       </button>
      </div>
      <!-- Download Button -->
      <div class="col-lg-4 my-2">
       <button id="btn-download" class="btn w-75 px-4 btn-outline-primary">
        <i class="fa-solid fa-download me-1"></i>
        <span>Download</span>
       </button>
      </div>
      <!-- Share Button -->
      <div class="col-lg-4 m-auto my-2">
        <button id="btn-share" class="btn w-75 px-4 btn-outline-success">
         <i class="fa-solid fa-share-from-square me-1"></i>
         <span>Share</span>
        </button>
       </div>
     </div>
     <!-- End of Row: Button Group -->
    </div>
    <!-- End of Input PDF File & Signature -->

    <!-- Control & Preview PDF -->
    <div id="preview-container" class="col-md mx-2 p-0">
     <iframe src="" id="pdf" style="width: 100%; height: 100%; z-index: 1;"></iframe>
    </div>
    <!-- End of Control & Preview PDF -->
   </div>

 </body>
</html>